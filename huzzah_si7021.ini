#include <SPI.h>
#include <SD.h>
#include "Adafruit_Si7021.h"
#include "RTClib.h"

Adafruit_Si7021 sensor = Adafruit_Si7021();
RTC_PCF8523 rtc;
File dataFile;

void setup() {
  Serial.begin(115200);


  Serial.println("huzzah_si7021_SDcard_funkcni.ino/MAC_computer");
  while (!Serial) {
    delay(10);  // Wait for serial port to open
  }

  Serial.println("Si7021 test!");
  if (!sensor.begin()) {
    Serial.println("Did not find Si7021 sensor!");
    while (true);  // Infinite loop
  }

  if (!rtc.begin()) {
    Serial.println("Couldn't find RTC");
    while (true);  // Infinite loop
  }

  if (!rtc.initialized() || rtc.lostPower()) {
    Serial.println("RTC is NOT initialized, let's set the time!");
    rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));  // Set the RTC to the date & time this sketch was compiled
  }

  Serial.print("Initializing SD card...");
  if (!SD.begin(SS)) {
    Serial.println("initialization failed!");
    return;
  }
  Serial.println("initialization done.");

  // Open a file to write data
  dataFile = SD.open("data.txt", FILE_WRITE);
  if (!dataFile) {
    Serial.println("Error opening data file!");
    return;
  }
}

void loop() {
  DateTime now = rtc.now();
  float humidity = sensor.readHumidity();
  float temperature = sensor.readTemperature();

  // Print to Serial Monitor
  Serial.print(now.year(), DEC); Serial.print('/'); Serial.print(now.month(), DEC);
  Serial.print('/'); Serial.print(now.day(), DEC); Serial.print(" ");
  Serial.print(now.hour(), DEC); Serial.print(':'); Serial.print(now.minute(), DEC);
  Serial.print(':'); Serial.print(now.second(), DEC); Serial.print(" - ");
  Serial.print("Humidity: "); Serial.print(humidity, 2);
  Serial.print("\tTemperature: "); Serial.println(temperature, 2);

  // Write to SD card
  if (dataFile) {
    dataFile.print(now.year(), DEC); dataFile.print('/'); dataFile.print(now.month(), DEC);
    dataFile.print('/'); dataFile.print(now.day(), DEC); dataFile.print(" ");
    dataFile.print(now.hour(), DEC); dataFile.print(':'); dataFile.print(now.minute(), DEC);
    dataFile.print(':'); dataFile.print(now.second(), DEC); dataFile.print(" - ");
    dataFile.print("Humidity: "); dataFile.print(humidity, 2);
    dataFile.print("\tTemperature: "); dataFile.println(temperature, 2);
    dataFile.flush();  // Ensure data is written to the card
  } else {
    Serial.println("Error writing to data file!");
  }

  delay(60000);  // Delay between readings
}
